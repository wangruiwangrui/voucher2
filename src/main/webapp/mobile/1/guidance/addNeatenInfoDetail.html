<!DOCTYPE html>
<html>
<head>
    <title>新建隐患整改(需要维修)</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width,height=device-height,inital-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="format-detection" content="telephone=no" />
<meta charset="utf-8" />
 <script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
    <link rel="stylesheet" href="../css/weui.css"/>
    <link rel="stylesheet" href="../css/example.css"/>
    <script src="../../../js/swiper.js"></script>
    <script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
 	<script src="../../../js/jquery-weui.js"></script>
 	<link rel="stylesheet" href="../css/jquery-weui.css">
<style type="text/css">
    body, html,#allmap {width: 100%;height: 70%;margin:0;font-family:"微软雅黑";}
</style>
<script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=cR98TwX2FnKTpANIOYhMYMot9a4ioxjc"></script>
<script type="text/javascript" src="https://api.map.baidu.com/library/CurveLine/1.5/src/CurveLine.min.js"></script>
</head>
<body>

  <div class="weui-cells weui-cells_form">
            <div class="weui-cell">
                <div class="weui-cell__hd"><label class="weui-label">资产地址</label></div>
                <div id="address" class="weui-cell__bd">
                </div>
            </div>
    </div>
    
    <div class="weui-cells weui-cells_form">
            <div class="weui-cell">
                <div class="weui-cell__hd"><label class="weui-label">资产编号</label></div>
                <div id="num" class="weui-cell__bd">
                </div>
            </div>
    </div>

    <div class="weui-cells weui-cells_form">
      <div class="weui-cell">
        <div class="weui-cell__hd"><label class="weui-label">关联隐患</label></div>
          <div id="hiddenCircs" class="weui-cell__bd">
     	</div>
      </div>
    </div>

	<div class="weui-cells weui-cells_form">
		<div class="weui-cell">
			<div class="weui-cell__hd"><label class="weui-label">整改项目</label></div>
			<div id="item" class="weui-cell__bd"></div>
		</div>
	</div>

	<div class="weui-cells weui-cells_form">
      <div class="weui-cell">
             <div class="weui-cell__hd"><label class="weui-label">整改进度</label></div>
                <div id="progress" class="weui-cell__bd">
                </div>
            <div id="progress_img" class="weui-cell weui-cell_warn">                  
            </div>
         </div>
    </div>

   	<div id="repair"><!-- 维修记录 -->
	
		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd"><label class="weui-label">维修类型</label></div>
				<div id="type" class="weui-cell__bd"></div>
			</div>
		</div>

		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd">
					<label class="weui-label">维修面积(㎡)</label>
				</div>
				<div class="weui-cell__bd">
					<input id="area" type="number" class="weui-input" />
				</div>
			</div>
		</div>

		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd">
					<label class="weui-label">送审金额(元)</label>
				</div>
				<div class="weui-cell__bd">
					<input id="amount" type="number" class="weui-input" />
				</div>
			</div>
		</div>
		
		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd">
					<label class="weui-label">审减金额(元)</label>
				</div>
				<div class="weui-cell__bd">
					<input id="amountTotal" type="number" class="weui-input" />
				</div>
			</div>
		</div>
		
		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd">
					<label class="weui-label">审定金额(元)</label>
				</div>
				<div class="weui-cell__bd">
					<input id="auditingAmount" type="number" class="weui-input" />
				</div>
			</div>
		</div>
		
		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd">
					<label class="weui-label">质保期(年)</label>
				</div>
				<div class="weui-cell__bd">
					<input id="availabeLength" class="weui-input" />
				</div>
			</div>
		</div>
		
		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd">
					<label class="weui-label">施工单位</label>
				</div>
				<div class="weui-cell__bd">
					<input id="workUnit"  class="weui-input" />
				</div>
			</div>
		</div>
		

	</div>
   
  <div class="weui-cells weui-cells_form">
     <div class="weui-cell">
        <div class="weui-cell__hd"><label class="weui-label">整改人员</label></div>
        <div  class="weui-cell__bd">
          <input id="principal" class="weui-input" />
        </div>
     </div>
    </div>
  
    <div class="weui-cells weui-cells_form">
           <div class="weui-cell">
                <div class="weui-cell__hd"><label class="weui-label">录入人员</label></div>
                <div id="username" class="weui-cell__bd">
                </div>
          </div>
    </div>
  
  <div class="weui-cells weui-cells_form">
     <div class="weui-cell">
        <div class="weui-cell__hd"><label class="weui-label">整改时间</label></div>
        <div  class="weui-cell__bd">
         <input id="happenTime" class="weui-input" type="date"/>
        </div>
     </div>
    </div>

  
  <div class="weui-cells weui-cells_form">
     <div class="weui-cell">
        <div class="weui-cell__hd"><label class="weui-label">备注</label></div>
        <div  class="weui-cell__bd">
         <input id="remark" class="weui-input" />
        </div>
     </div>
    </div>
  
    <div class="weui-cells__title">整改详情</div>
    <div class="weui-cells weui-cells_form">
            <div class="weui-cell">
                <div class="weui-cell__bd">
                  <textarea id="neaten_instance" class="weui-textarea" rows="3" placeholder="请输入需要整改项目(必填)"></textarea>
                </div>
            </div>
        </div>


   <div class="weui-cell weui-cell_access">
           <div class="weui-cell__bd">资产位置</div>
            <div class="weui-cell__ft" style="font-size: 0">               
                 <span id="navigation" class="weui-btn weui-btn_mini weui-btn_primary" >导航路线</span>
            </div>
     </div>
    <div id="allmap"></div>

	<div class="weui-panel weui-panel_access">
		<div class="weui-panel__hd">资产关联隐患图片</div>
		<div id="img" class="weui-panel__bd"></div>
	</div>

	<a href="javascript:;" id="save" class="weui-btn weui-btn_plain-primary">保存</a>
	
</body>

<script type="text/javascript">
  function getQueryString(name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
    var r = window.location.search.substr(1).match(reg);
    if (r != null) return unescape(r[2]); return null;
   }

  var guid=getQueryString("guid");
  var item=getQueryString("item");
  
  var longitude=getQueryString("longitude");
  var latitude=getQueryString("latitude");
  
  var is_repair=1;
  
  console.log(item);
  
    // 百度地图API功能
    var map = new BMap.Map("allmap");    // 创建Map实例

	var point = new BMap.Point(longitude, latitude);
    
    var pointStart=point;

	var str = "我的位置";
	var opts = {
			   position : point,    // 指定文本标注所在的地理位置
			   offset   : new BMap.Size(-getByteLen(str)*3, 5)    //设置文本偏移量
			}	
	var label = new BMap.Label(str, opts);  // 创建文本标注对象
	label.setStyle({
					 fontSize : "12px",
					 height : "20px",
					 lineHeight : "20px",
					 fontFamily:"微软雅黑"
				  });
    map.addOverlay(label);
    map.enableScrollWheelZoom(true);
    
    var geoc = new BMap.Geocoder();
  	
	function keyDown(e) {   		  
	　   var keycode = e.which;   //取得对应的键值（数字）  	  
	　   var realkey = String.fromCharCode(e.which); //取得代表改键的真正字符  
	   var val = document.getElementById("input").value;
	　   if(keycode==13){
		   local.search(val);
	　   }
	 }     
        
	$("#repair").hide();
	
	var select = document.createElement("select");
	select.setAttribute("id","select");
	select.setAttribute("onchange","gradeChange()");

	var option = document.createElement("option");
	option.innerHTML="整改中";
	option.setAttribute("value",0);
	select.appendChild(option);		
	progress_img.setAttribute("class","weui-icon-info-circle");  
	
	var option = document.createElement("option");
	option.innerHTML="整改完成";
	option.setAttribute("value",1);
	select.appendChild(option);	

	select.setAttribute("class","weui-input");
	$("#progress").append(select);	

	var progress="整改中";

	function gradeChange(){ 
    var objS = document.getElementById("select"); 
    var grade = objS.options[objS.selectedIndex].value; 
    console.log(objS.options[objS.selectedIndex]);
    progre=grade;
	 if(progre==0){
    	  progress="整改中";
    	  progress_img.setAttribute("class","weui-icon-info-circle");  
    	  $("#repair").hide();
      }else if(progre==1){
    	  progress="整改完成";
    	  progress_img.setAttribute("class","weui-icon-success");
    	  $("#repair").show();
      }
   } 
	
	var select2 = document.createElement("select");
	select2.setAttribute("id","select2");
	select2.setAttribute("onchange","gradeChange2()");

	var option2 = document.createElement("option");
	option2.innerHTML="排危工程";
	option2.setAttribute("value",0);
	select2.appendChild(option2);		
	
	var option2 = document.createElement("option");
	option2.innerHTML="小修";
	option2.setAttribute("value",1);
	select2.appendChild(option2);	

	var option2 = document.createElement("option");
	option2.innerHTML="大中修";
	option2.setAttribute("value",2);
	select2.appendChild(option2);
	
	var option2 = document.createElement("option");
	option2.innerHTML="其他";
	option2.setAttribute("value",3);
	select2.appendChild(option2);
	
	select2.setAttribute("class","weui-input");
	$("#type").append(select2);	

	var type="排危工程";
	
	function gradeChange2(){ 
	    var objS = document.getElementById("select2"); 
	    var grade = objS.options[objS.selectedIndex].value; 
	    console.log(objS.options[objS.selectedIndex]);
	    progre=grade;
		 if(progre==0){
	    	  type="排危工程";
	      }else if(progre==1){
	    	  type="小修";
	      }else if(progre==2){
	    	  type="大中修";
	      }else if(progre==3){
	    	  type="其他";
	      }
	   }
	
	var addressValue;
	
	$.post('/voucher/mobile/register/userinfoByopenId.do', {
		campusId:1
       },function(data){
    	   var obj = $.parseJSON(data);
    	   if(obj.name!=null)
    	   $("#principal").val(obj.name);
    	   var username=document.createElement("span");
		   username.innerHTML=obj.user_name;
           $("#username").append(obj.name);
       });
	
	$.ajax({
        type: "POST",
        url: "/voucher/mobile/asset/getRoomInfoByGUID.do",
        data: { "guid":guid},
        dataType: "json",
        error: function (request){
     	   console.log(request);
        },
        success: function (text) {              	   
        	console.log(text);
      	   var obj=text.roomInfo;
      	   var imgs=text.hiddenCheckFileBytes;
   
              	   var guid=obj.guid;
   
              	  var distance=null;
             	   console.log(obj.name+"   "+obj.detail+"  "+obj.lng+"   "+obj.lat);
             	   if(obj.lng!=""&&obj.lat!=""){
             	   	  distance=getDistance(obj.lng,obj.lat);
             	   	var point = new BMap.Point(obj.lng,obj.lat);
             	    var pointEnd=point;
             	    map.centerAndZoom(point, 12);
             	    var myIcon = new BMap.Icon("../../img/blackPoint.jpg", new BMap.Size(30,38));
             	    var marker = new BMap.Marker(point); // 创建点
             		map.addOverlay(marker);    //增加点
             	   }
             	  
             	  navigation(pointStart, pointEnd);
              	  
             	  if(obj.lng!=""&&obj.lat!=""){
             	  	$("#navigation").on("click",function(){
             		  location.href="/voucher/mobile/1/navigation.html?latitude="+latitude+"&longitude="+longitude+"&latitude2="+obj.lat+"&longitude2="+obj.lng;
             	  	});
             	  }else{
             		  $("#navigation").hide();
             	  }
             	  
              	 var address=document.createElement("span");
                	  address.innerHTML=obj.address;
                   $("#address").append(address);
                  addressValue=obj.address;
                  
                  <!--
                  var manageRegion=document.createElement("span");
                   manageRegion.innerHTML=obj.manageRegion;
                   $("#manageRegion").append(manageRegion);
                  -->
                  
                  var num=document.createElement("span");
                  num.innerHTML=obj.num;
                  $("#num").append(num);
                  
                  
                  if(imgs!=null){
                  	   var i = 0;
                         for(; i < imgs.length; i++){
                      	   
                      	  var data=imgs[i];
                      	  var name=data.name;
                      	  var uri=data.compressUri;
                      	  var date=data.date;
                      	  var panel=document.createElement("div");
                      	  panel.setAttribute("class","weui-panel__bd");
                        	   var a=document.createElement("a");
                       	   a.setAttribute("class","weui_grid");
                       	   var a=document.createElement("a");
                       	  a.setAttribute("href","javascript:void(0);");
                       	   a.setAttribute("class","weui-media-box weui-media-box_appmsg");
                       	   var div=document.createElement("div");
                       	  	div.setAttribute("class","weui-media-box__hd");
                       	  
                  	   	 	 src="/voucher/"+uri;
                  	  	  	var img=document.createElement("img");
                  	  	  	img.setAttribute("class","weui-media-box__thumb");
                            	img.setAttribute("src",src);
                          
                         	  	div.appendChild(img);
                         	   		
                         	  	div2=document.createElement("div");
                         	  		div2.setAttribute("class","weui-media-box__bd");
                         	 		h4=document.createElement("h4");
                         	 		h4.setAttribute("class","weui-media-box__title");   
                         	 		h4.innerHTML=name;
                         	  	 	p=document.createElement("p");
                         	  	 	p.setAttribute("class","weui-media-box__desc");
                         	  		p.innerHTML=date;
                         	     div2.appendChild(h4);
                         	     div2.appendChild(p);
                         	   a.appendChild(div);
                         	   a.appendChild(div2);
                         	   panel.appendChild(a);
                  	      	  $("#img").append(panel);
                         }
          		   
          	   		}
                                     
        	}
    });
	
	$.ajax({
        type: "POST",
        url: "/voucher/mobile/hidden/getRoomInfoHiddenItemDataByGUID.do",
        data: { "guid":guid},
        dataType: "json",
        error: function (request){
     	   console.log(request);
        },
        success: function (text) {
        	//console.log(text);
        	var hiddenCircs=document.createElement("span");
        	hiddenCircs.innerHTML="<font color='#FF0000'>"+text+"</font>";
            $("#hiddenCircs").append(hiddenCircs);
        }
     });
	
	var checkItem=new Object();
	
	console.log(item);
	var item=item.replace("[","");
	var item=item.replace("]","");
	var reg = new RegExp('"',"g");  
	var item = item.replace(reg, "");  
	var item=item.split(",");
	console.log(item);
	var text="";
	
	for(var i=0;i<item.length;i++){		
		console.log(item[i]);
		if(item[i]=="fire_extinguisher"){
	  		text=text+"灭火器,";
	  		checkItem.fire_extinguisher=1;
	  	}else if(item[i]=="high_power"){
  			text=text+"大功率用电器,";
  			checkItem.high_power=1;
  		}else if(item[i]=="blow"){
  			text=text+"易燃易爆物品,";
  			checkItem.blow=1;
  		}else if(item[i]=="line_aging"){
  			text=text+"线路老化,";
  			checkItem.line_aging=1;
  		}else if(item[i]=="incline"){
  			text=text+"倾斜,";
  			checkItem.incline=1;
  		}else if(item[i]=="split"){
  			text=text+"开裂,";
  			 checkItem.split=1;
  		}else if(item[i]=="down"){
  			text=text+"地基下沉,";
  			checkItem.down=1;
  		}else if(item[i]=="break_off"){
  			text=text+"屋面脱落,";
  			checkItem.break_off=1;
  		}else if(item[i]=="destroy"){
  			text=text+"结构破坏,";
  			checkItem.destroy=1;
  		}else if(item[i]=="invalidation"){
  			text=text+"承重失效,";
  			checkItem.invalidation=1;
  		}else if(item[i]=="flaw"){
  			text=text+"漏雨,";
  			checkItem.flaw=1;
  		}else if(item[i]=="cesspool"){
  			text=text+"化粪池问题,";
  			checkItem.cesspool=1;
  		}else if(item[i]=="coast"){
  			text=text+"山体滑坡,";
  			checkItem.coast=1;
  		}else if(item[i]=="wall_up"){
  			text=text+"管道堵塞,";
  			checkItem.wall_up=1;
  		}else if(item[i]!=""){
  			var gid=encodeURI(guid);
  			var xhm=new XMLHttpRequest();
   	    	xhm.open("GET","/voucher/mobile/hidden/getRoomInfoHiddenItemByGUID.do?guid="+gid,false);
   	    	xhm.setRequestHeader("Content-type","application/x-www-form-urlencoded");
   	    	xhm.send();
   	    	var ticket=JSON.parse(xhm.responseText);
  			text=ticket.other+","+text;
	    	checkItem.other=ticket.other;
	    }
	}
	text="<font color='#3366FF'>"+text.substr(0, text.length - 1);  +"</font>";
	$("#item").append(text);
	
	function actionTime(value){
  	    var date = new Date(value); 
  	    Y = date.getFullYear() + '-';
  	    M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
  	  	D = date.getDate()<10?'0'+date.getDate():date.getDate();
  	    h = date.getHours() + ':';
  	    m = date.getMinutes() + ':';
  	    s = date.getSeconds(); 
  		return Y+M+D;
  	}
	

    
    function getByteLen(val) {    //传入一个字符串
        var len = 0;
        for (var i = 0; i < val.length; i++) {
            if (val[i].match(/[^\x00-\xff]/ig) != null) //全角 
                len += 2; //如果是全角，占用两个字节  如果mysql中某字段是text, 如果设置编码为utf-8,那么一个中文是占3个字节, gbk是两个字节
            else
                len += 1; //半角占用一个字节
        }
        return len;
     }  
    
    function getDistance(lng,lat){
    	var pointA = new BMap.Point(longitude,latitude);  // 创建点坐标A--大渡口区
    	var pointB = new BMap.Point(lng,lat);  // 创建点坐标B--江北区
    	var d=map.getDistance(pointA,pointB)/1000;
    	return d.toFixed(2)+' KM';  //获取两点距离,保留小数点后两位
    }
    
  //线路
    function navigation(p1, p2) {
            var points = [p1,p2];
        	var curve = new BMapLib.CurveLine(points, {strokeColor:"blue", strokeWeight:3, strokeOpacity:0.5});
        	map.addOverlay(curve);
    }
    
  //happenTime设置为当前时间
	var timestamp=actionTime(Date.parse(new Date()));
    console.log(timestamp);
    $("#happenTime").val(timestamp); 
  
    $("#save").on("click",function(){

	
    	geoc.getLocation(point, function(rs){
    	    var addComp;
    	  	addComp = rs.addressComponents;
        	      	
        	var principal=$("#principal").val();
        	var happenTime=$("#happenTime").val();
        	var remark=$("#remark").val();
        	var neaten_instance=$("#neaten_instance").val();
        	var addComp1=JSON.stringify(addComp);

        	var area=$("#area").val();
        	var amount=$("#amount").val();
        	var amountTotal=$("#amountTotal").val();
        	var auditingAmount=$("#auditingAmount").val();
        	var availabeLength=$("#availabeLength").val();
        	var workUnit=$("#workUnit").val();
        	
        	if(progress=="整改完成"){
        		var error="";
				if(area==null||area==""){
        			error="面积不能为空!";
        		}else if(amount==null||amount==""){
        			error="送审金额不能为空!";
        		}else if(amountTotal==null||amountTotal==""){
        			error="审减金额不能为空!";
        		}else if(auditingAmount==null||auditingAmount==""){
        			error="审定金额不能为空!";
        		}else if(availabeLength==null||availabeLength==""){
        			error="质保期不能为空!";
        		}else if(neaten_instance==null||neaten_instance==""){    				
        			error="请填写整改详情说明!";
    			}
            	
        		
        		if(error!=""){
        			
        			$.alert(error);
        			
        			return false;
        		}
        		        		
        	}
        	console.log(item);
        	 $.post("/voucher/mobile/hidden/insertHiddenNeaten.do",
        		{
 					guid:guid,
 					address:addressValue,
    		    	happenTime:happenTime,
    		    	principal:principal,
    		    	progress:progress,
    		    	is_repair:is_repair,
    		    	remark:remark,
    		    	neaten_instance:neaten_instance,
    		    	addComp:addComp1,
    		    	lng:longitude,
    		    	lat:latitude,
    		    	type:type,
    		    	area:area,
    		    	amount:amount,
    		    	amountTotal:amountTotal,
    		    	auditingAmount:auditingAmount,
    		    	availabeLength:availabeLength,
    		    	workUnit:workUnit,
    		    	checkItemDate:JSON.stringify(checkItem)
    		    }, function(data){
    	        	var obj = $.parseJSON(data);
    		    	if (obj.status == "failure") {
    		    		$.alert("新建"+name+"隐患整改记录失败!",function() {
			        		  //点击确认后的回调函数
			        		history.back();
			        	});
    		        	console.log(obj.status);
    		        } else if (obj.status == "succeed") {
    		            //存储到服务器成功后的处理
    		            //
    		            var neaten_id=obj.neaten_id;

    		            $.alert("新建"+name+"隐患整改记录成功!","",function(){
    		        		
   		        		 $.confirm("是否上传隐患整改记录"+name+"的照片", function() {
      	     	    			//点击确认后的回调函数
      			            	
      	     	    			location.href="NeatenInfoDetail.html?neaten_id="+neaten_id+"&latitude="+latitude+"&longitude="+longitude;
      	     	    			
      			            	}, function() {
      	     	    			//点击取消后的回调函数
      	     	    			
      	     	    			history.go(-2);
      	     	    			
      	     	    		});
   		        		 
   		        		});
    		        	
    		       	 }else{
    			        	
    			        	$.alert("新建隐患整改记录失败!",function() {
    			        		  //点击确认后的回调函数
    			        		   history.go(-2);
    			        	});
    			        	
    			     }
    		    });
    	  
    	   }); 
    	
    });

</script>

<script src="../../../js/previewImage.min.js"></script>

<script>
 
 var im = {};
 /**
  * 得到多个元素
  * @public
  */
 im.all = function(selector, contextElement) {
     var nodeList,
         list = [];
     if (contextElement) {
         nodeList = contextElement.querySelectorAll(selector);
     } else {
         nodeList = document.querySelectorAll(selector);
     }
     if (nodeList && nodeList.length > 0) {
         list = Array.prototype.slice.call(nodeList);
     }
     return list;
 }

 /**
  * 将事件委托给父元素
  * @public
  * @param  array     $el         父元素
  * @param  string    eventType  事件类型名称
  * @param  string    selector   目标的选择器
  * @param  function  fn
  */
 im.delegate = function($el, eventType, selector, fn) {
     if (!$el) { return; }
     $el.addEventListener(eventType, function(e) {
         var targets = im.all(selector, $el);
         if (!targets) {
             return;
         }
         // findTarget:
         for (var i=0; i<targets.length; i++) {
             var $node = e.target;
             while ($node) {
                 if ($node == targets[i]) {
                     fn.call($node, e);
                     break; //findTarget;
                 }
                 $node = $node.parentNode;
                 if ($node == $el) {
                     break;
                 }
             }
         }
     }, false);
 };


 im.delegate(document.querySelector('#img'), 'click','img',function(){
	 
	 var urls = [];
	 var imgs = im.all('img',im.all('#img')[0]);
	 imgs.forEach(function(v,i){
	     urls.push(v.src);
	 })
     
	 var thisStr = this.src;
	 var current = thisStr.replace(/\/compressFile/, "");
	 console.log(current);
     var obj = {
         urls : urls,
         current : current
     };
     previewImage.start(obj);
 });
 
</script>
