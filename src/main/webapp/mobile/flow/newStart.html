<!DOCTYPE html>
<html>
<head>
    <title>房屋维修申请</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width,height=device-height,inital-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="format-detection" content="telephone=no" />
<meta charset="utf-8" />
 <script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
    <link rel="stylesheet" href="../1/css/weui.css"/>
    <link rel="stylesheet" href="../1/css/example.css"/>
    <script src="../../js/swiper.js"></script>
    <script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
 	<script src="../../js/jquery-weui.js"></script>
 	<link rel="stylesheet" href="../1/css/jquery-weui.css">
 	<script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=cR98TwX2FnKTpANIOYhMYMot9a4ioxjc"></script>
	<script type="text/javascript" src="https://api.map.baidu.com/library/CurveLine/1.5/src/CurveLine.min.js"></script>
<style type="text/css">
    body, html,#allmap {width: 100%;height: 70%;margin:0;font-family:"微软雅黑";}
    .weui-cell__bd{
    	margin-left: 1em;
    }
    .instance{
    	margin-left: 0em;
    }
</style>

</head>
<body>

  	<div class="weui-cells weui-cells_form">
            <div class="weui-cell">
                <div class="weui-cell__hd"><label class="weui-label">资产地址</label></div>
                <div id="address" class="weui-cell__bd">
                </div>
            </div>
    </div>
    <div class="weui-cells weui-cells_form">
        <div class="weui-cell">
            <div class="weui-cell__hd"><label class="weui-label">资产编号</label></div>
            <div id="num" class="weui-cell__bd">
            </div>
        </div>
    </div>
<!--     
    <div class="weui-cells weui-cells_form">
      <div class="weui-cell">
        <div class="weui-cell__hd"><label class="weui-label">关联隐患</label></div>
          <div id="hiddenCircs" class="weui-cell__bd">
     	</div>
      </div>
    </div> 

	<div class="weui-cells weui-cells_form">
		<div class="weui-cell">
			<div class="weui-cell__hd"><label class="weui-label">整改项目</label></div>
			<div id="item" class="weui-cell__bd"></div>
		</div>
	</div>
	-->
	
   	<div id="repair"><!-- 维修记录 -->
   	
   		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd"><label class="weui-label">维修类型</label></div>
				<div id="type" class="weui-cell__bd"></div>
			</div>
		</div>
   		
		<div class="weui-cells weui-cells_form">
            <div class="weui-cell">
            <div class="weui-cell__hd"><label class="weui-label">整改项目</label></div>
                <div class="weui-cell__bd">
                    <textarea id="itemHidden" class="weui-textarea" placeholder="请输入需要整改项目(必填)" rows="3"></textarea>
                    <div class="weui-textarea-counter"></div>
                </div>
            </div>
        </div>
	
		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd">
					<label class="weui-label">维修面积(㎡)</label>
				</div>
				<div class="weui-cell__bd">
					<input id="area" type="number" class="weui-input" />
				</div>
			</div>
		</div>

		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd">
					<label class="weui-label">送审金额(元)</label>
				</div>
				<div class="weui-cell__bd">
					<input id="amount" type="number" class="weui-input" />
				</div>
			</div>
		</div>
	<!--  
		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd">
					<label class="weui-label">审减金额</label>
				</div>
				<div class="weui-cell__bd">
					<input id="amountTotal" type="number" class="weui-input" />
				</div>
			</div>
		</div>
		
		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd">
					<label class="weui-label">审定金额</label>
				</div>
				<div class="weui-cell__bd">
					<input id="auditingAmount" type="number" class="weui-input" />
				</div>
			</div>
		</div>
	-->	
		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd">
					<label class="weui-label">质保期(年)</label>
				</div>
				<div class="weui-cell__bd">
					<input id="availabeLength" type="number" class="weui-input" />
				</div>
			</div>
		</div>
		
		<div class="weui-cells weui-cells_form">
			<div class="weui-cell">
				<div class="weui-cell__hd">
					<label class="weui-label">施工单位</label>
				</div>
				<div class="weui-cell__bd">
					<input id="workUnit"  class="weui-input" />
				</div>
			</div>
		</div>
		

	</div>
   
  <div class="weui-cells weui-cells_form">
     <div class="weui-cell">
        <div class="weui-cell__hd"><label class="weui-label">整改人员</label></div>
        <div  class="weui-cell__bd">
          <input id="principal" class="weui-input" />
        </div>
     </div>
    </div>
  

  
  <div class="weui-cells weui-cells_form">
     <div class="weui-cell">
        <div class="weui-cell__hd"><label class="weui-label">整改时间</label></div>
        <div  class="weui-cell__bd">
         <input id="happenTime" class="weui-input" type="date"/>
        </div>
     </div>
    </div>

  
  <div class="weui-cells weui-cells_form">
     <div class="weui-cell">
        <div class="weui-cell__hd"><label class="weui-label">备注</label></div>
        <div  class="weui-cell__bd">
         <input id="remark" class="weui-input" />
        </div>
     </div>
    </div>
  
    <div class="weui-cells__title">整改详情</div>
    <div class="weui-cells weui-cells_form">
            <div class="weui-cell">
                <div class="weui-cell__bd instance">
                  <textarea id="neaten_instance" class="weui-textarea" rows="3" placeholder="必填"></textarea>
                </div>
            </div>
        </div>

	<div class="weui-cells weui-cells_form">
           <div class="weui-cell">
                <div class="weui-cell__hd"><label class="weui-label">申请人员</label></div>
                <div id="username" class="weui-cell__bd">
                </div>
          </div>
    </div>

 	<div class="weui-cells weui-cells_form"> 
    </div>
<<<<<<< HEAD

     
    <div class="weui-panel weui-panel_access">
		<div class="weui-panel__hd">维修照片</div>
		<div id="img0" class="weui-panel__bd"></div>
		<div id="img" class="weui-panel__bd"></div>
	</div>

	<div class="weui-panel weui-panel_access">
		<div class="weui-uploader__input-box" id="showPicker"></div>
	</div>

<!--
	<div class="weui-panel weui-panel_access">
		<div class="weui-panel__hd">维修照片</div>
		<div id="img" class="weui-panel__bd">
		</div>
	</div>
<!-- 
	<div class="weui-panel weui-panel_access">
		<div class="weui-uploader__input-box" id="showPicker">
		</div>
	</div> -->

	<a href="javascript:;" id="save" class="weui-btn weui-btn_block weui-btn_primary">提交申请</a> 
</body>

<script type="text/javascript">
  var neaten_type = 1;
  function getQueryString(name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
    var r = window.location.search.substr(1).match(reg);
    if (r != null) return unescape(r[2]); return null;
   }

  var guid=getQueryString("guid");
  var longitude=getQueryString("longitude");
  var latitude=getQueryString("latitude");
  
  var is_repair=1;
  
  var point = new BMap.Point(longitude, latitude);
  
  var geoc = new BMap.Geocoder();
  
  var username;
  
  var neatenitem;
  
	function keyDown(e) {   		  
	　   var keycode = e.which;   //取得对应的键值（数字）  	  
	　   var realkey = String.fromCharCode(e.which); //取得代表改键的真正字符  
	   var val = document.getElementById("input").value;
	　   if(keycode==13){
		   local.search(val);
	　   }
	 }     
        		
	var select2 = document.createElement("select");
	select2.setAttribute("id","select2");
	select2.setAttribute("onchange","gradeChange2()");

	var option2 = document.createElement("option");
	option2.innerHTML="排危工程";
	option2.setAttribute("value",0);
	select2.appendChild(option2);		
	
	var option2 = document.createElement("option");
	option2.innerHTML="小修";
	option2.setAttribute("value",1);
	select2.appendChild(option2);	

	var option2 = document.createElement("option");
	option2.innerHTML="大中修";
	option2.setAttribute("value",2);
	select2.appendChild(option2);
	
	var option2 = document.createElement("option");
	option2.innerHTML="其他";
	option2.setAttribute("value",3);
	select2.appendChild(option2);
	select2.setAttribute("class","weui-input");
	$("#type").append(select2);	
	var type="排危工程";
	function gradeChange2(){ 
	    var objS = document.getElementById("select2"); 
	    var grade = objS.options[objS.selectedIndex].value; 
	    console.log(objS.options[objS.selectedIndex]);
	    progre=grade;
		 if(progre==0){
	    	  type="排危工程";
	      }else if(progre==1){
	    	  type="小修";
	      }else if(progre==2){
	    	  type="大中修";
	      }else if(progre==3){
	    	  type="其他";
	      }
	   }
	var addressValue;
	var xhm=new XMLHttpRequest();
    xhm.open("GET","/voucher/mobile/register/userinfoByopenId.do?campusId=1",false);
    xhm.setRequestHeader("Content-type","application/x-www-form-urlencoded");
    xhm.send();
    var obj=JSON.parse(xhm.responseText);

/* $("#img").children('div').remove();
 	if(imgs!=null){
    	var i = 0;
        for(; i < imgs.length; i++){
     	   
     		var data=imgs[i];
     		var name=data.name;
     		var uri=data.uri;
     		var date=actionTime(data.date);
     		var panel=document.createElement("div");
     		panel.setAttribute("class","weui-panel__bd");
   			var a=document.createElement("a");
      		a.setAttribute("class","weui_grid");
      		var a=document.createElement("a");
      		a.setAttribute("href","javascript:void(0);");
      		a.setAttribute("class","weui-media-box weui-media-box_appmsg");
      		var div=document.createElement("div");
      	  	div.setAttribute("class","weui-media-box__hd");
      	  
 	   		src="/voucher/Desktop/pasoft/photo/"+uri;
 	  	  	var img=document.createElement("img");
 	  	  	img.setAttribute("class","weui-media-box__thumb");
           	img.setAttribute("src",src);
        	  	div.appendChild(img);
        	  	div2=document.createElement("div");
       	  		div2.setAttribute("class","weui-media-box__bd");
       	 		h4=document.createElement("h4");
       	 		h4.setAttribute("class","weui-media-box__title");
       	 	 	h4.innerHTML=name;
       	  	 	p=document.createElement("p");
       	  	 	p.setAttribute("class","weui-media-box__desc");
       	  	 	p.innerHTML=date;
        	    div2.appendChild(h4);
        	    div2.appendChild(p);
        		a.appendChild(div);
        		a.appendChild(div2);
      			panel.appendChild(a);
 	      	  $("#img0").append(panel);
        }
		   
	} 
	*/

    if(obj.name!=null)
     $("#principal").val(obj.name);
    var username=document.createElement("span");
	username.innerHTML=obj.user_name;
    $("#username").append(obj.name);
    username=obj.name;
	$.ajax({
        type: "POST",
        url: "/voucher/mobile/asset/getRoomInfoByGUID.do",
        data: { "guid":guid},
        dataType: "json",
        error: function (request){
     	    console.log(request);
        },
        success: function (text) {              	   
            console.log(text);
      	    var obj=text.roomInfo;
      	    var imgs=text.hiddenCheckFileBytes;
            var guid=obj.guid;
            var address=document.createElement("span");
            var num=document.createElement("span");
            address.innerHTML=obj.address;
            num.innerHTML=obj.num;
            $("#address").append(address);
            $("#num").append(num);
            addressValue=obj.address;
        }
    });
	
	$.ajax({
        type: "POST",
        url: "/voucher/mobile/hidden/getRoomInfoHiddenItemDataByGUID.do",
        data: { "guid":guid},
        dataType: "json",
        error: function (request){
     	   console.log(request);
        },
        success: function (text) {
        	//console.log(text);
        	var hiddenCircs=document.createElement("span");
        	hiddenCircs.innerHTML="<font color='#FF0000'>"+text+"</font>";
            $("#hiddenCircs").append(hiddenCircs);
        }
     });
	
	var checkItem=new Object();
	
	function actionTime(value){
  	    var date = new Date(value); 
  	    Y = date.getFullYear() + '-';
  	    M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
  	  	D = date.getDate()<10?'0'+date.getDate():date.getDate();
  	    h = date.getHours() + ':';
  	    m = date.getMinutes() + ':';
  	    s = date.getSeconds(); 
  		return Y+M+D;
  	}
	
   
  //happenTime设置为当前时间
	var timestamp=actionTime(Date.parse(new Date()));
    console.log(timestamp);
    $("#happenTime").val(timestamp); 
  
    var id=Math.random().toString(36).substr(2);
    
    $("#save").on("click",function(){
    	
    	$.showLoading();
	
    	geoc.getLocation(point, function(rs){
    	    var addComp;
    	  	addComp = rs.addressComponents;
    	  	document.getElementById('cnt')
        	var itemHidden = $("#itemHidden").val();
        	var principal=$("#principal").val();
        	var happenTime=$("#happenTime").val();
        	var remark=$("#remark").val();
        	var neaten_instance=$("#neaten_instance").val();
        	var addComp1=JSON.stringify(addComp);

        	var area=$("#area").val();
        	var amount=$("#amount").val();
        	//var amountTotal=$("#amountTotal").val();
        	//var auditingAmount=$("#auditingAmount").val();
        	var availabeLength=$("#availabeLength").val();
        	var workUnit=$("#workUnit").val();
        	

        		var error="";
				if(area==null||area==""){
        			error="面积不能为空!";
        		}else if(itemHidden==null||itemHidden==""){
        			error="整改项目不能为空!";	
        		}else if(amount==null||amount==""){
        			error="送审金额不能为空!";
        		}else if(availabeLength==null||availabeLength==""){
        			error="质保期不能为空!";
        		}else if(neaten_instance==null||neaten_instance==""){    				
        			error="请填写整改详情说明!";
    			}
            	
        		
        		if(error!=""){
        			
        			$.alert(error);
        			$.hideLoading();
        			return false;
        		}
        		        		
        	
        	console.log("itemHidden111111",itemHidden);
        	
        	var variableData = new Object();
        	
        	variableData.guid=guid;
        	variableData.neaten_type=neaten_type;
        	variableData.neatenitem=itemHidden;
        	variableData.username=username;
        	variableData.address=addressValue;
        	variableData.happenTime=happenTime;
        	variableData.principal=principal;
        	variableData.remark=remark;
        	variableData.neaten_instance=neaten_instance;
        	variableData.addComp=addComp1;
        	variableData.lng=longitude;
        	variableData.lat=latitude;
        	variableData.type=type;
        	variableData.area=area;
        	variableData.amount=amount;
        	//variableData.amountTotal=amountTotal;
        	//variableData.auditingAmount=auditingAmount;
        	variableData.availabeLength=availabeLength;
        	variableData.workUnit=workUnit;
        	variableData.checkItemDate=JSON.stringify(checkItem);
        	
        	var variable = JSON.stringify(variableData);
        	
        	console.log(variable);
            
        	 $.ajax({
                 type: "post",
                 async: false,
                 url: "../../mobile/flow/start.do",
                 data: {	
                	 	processDefinitionKey:"neaten0",
              			variableData: variable,
              			className:"neaten0",
              			id:id
                 	}

                 ,
                 success: function (data) {
                 	var data=JSON.parse(data);
                 	console.log(data);
                     if (data.state == "succeed") {
                    	 $.hideLoading();
                    	 $.toast("提交成功");
                    	 history.go(-2);
                     } else {
                    	 $.hideLoading();
                    	 $.toast("提交错误", "forbidden");
                          return false;
                         	
                     	}
                 },
                 error:function (XMLHttpRequest, textStatus, errorThrown) { 
                	 $.hideLoading();
                	 $.toast("提交错误", "forbidden");
                       return false;
                 }
             });
        	 
    	   }); 
    	
    });

    console.log("id="+id);
    
	url = document.location.toString();

	$.ajax({
		url: "../../wechat/sign.do",
		data: {
			campusId: 1,
			url: url
		},
		async: false,
		type: "GET",
		success: function (data) {
			var ticket = JSON.parse(data);

			wx.config({
				debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
				appId: ticket.appId,
				timestamp: ticket.timestamp,
				nonceStr: ticket.nonceStr,
				signature: ticket.signature,
				jsApiList: ['checkJsApi', 'onMenuShareTimeline',
					'onMenuShareAppMessage', 'onMenuShareQQ',
					'onMenuShareWeibo', 'hideMenuItems', 'showMenuItems',
					'hideAllNonBaseMenuItem', 'showAllNonBaseMenuItem',
					'translateVoice', 'startRecord', 'stopRecord',
					'onRecordEnd', 'playVoice', 'pauseVoice', 'stopVoice',
					'uploadVoice', 'downloadVoice', 'chooseImage',
					'previewImage', 'uploadImage', 'downloadImage',
					'getNetworkType', 'openLocation', 'getLocation',
					'hideOptionMenu', 'showOptionMenu', 'closeWindow',
					'scanQRCode', 'chooseWXPay', 'openProductSpecificView',
					'addCard', 'chooseCard', 'openCard']
			});
			
	var images = {
			localId: [],
			serverId: []
		};


	document.querySelector('#showPicker').onclick = function () {
	    
		 $.modal({
			title: "选择上传图片类型",
			text: '<div class="weui-cell weui-cell_select weui-cell_select-after">' +
				'<div class="weui-cell__bd">' +
				'<select class="weui-select" id="select" name="select2">' +
				'<option value="1">维修前照片</option>' +
				' <option value="2">维修后照片</option>' +
				' </select>' +
				'</div>' +
				'</div>',
			buttons: [
				{
					text: "确定", onClick: function () {

						var objS = document.getElementById("select");
						var grade = objS.options[objS.selectedIndex].value;
						var imagename;
						if (grade == 1) {
							imagename = "维修前照片";
						} else if (grade == 2) {
							imagename = "维修后照片";
						}

						upImage(imagename);
					}
				},
				{ text: "取消", imagename: "1", onClick: function () { console.log(3) } },
			 ]
		 });

		 function upImage(imagename) {
			wx.chooseImage({
				success: function (res) {
					images.localId = res.localIds;
					console.log('已选择 ' + res.localIds.length
						+ ' 张图片');
					var i = 0, length = images.localId.length;
					images.serverId = [];
					function upload(imagename) {
						wx.uploadImage({
							localId: images.localId[i].toString(),
							isShowProgressTips: images.localId[i]
								.toString(),
							success: function (res) {
								i++;
								console.log('已上传：' + i + '/'
									+ length);
								//返回图片的服务器端ID res.serverId,然后调用wxImgCallback函数进行下载图片操作
								wxImgCallback(imagename, res.serverId);
								if (i < length) {
									upload(imagename);
								}
							},
							fail: function (res) {
								console.log(res);
							}
						});
					}
					upload(imagename);
				}
			});
		  }
	    
		}

	  }
	 });
	function wxImgCallback(imagename,serverId) {
	    //将serverId传给wx_upload.php的upload方法
	    var url = "../file/upload.do";
	    $.get(url,{
	    	campusId:1,
	    	imagename:imagename,
	    	serverId:serverId,
	    	id:id,
	    	classType:"imageData"
	    }, function(data){
	    	console.log(data);
	        if (data == 0) {
	        	alert("上传图片失败!");
	        	console.log(data.msg);
	        } else if (data == 1) {
	            //存储到服务器成功后的处理
	            //
	        	 $.get("../flow/findimagedata.do",{
	 		    	id:id
	 		    }, function(text){
	 		    	console.log("text="+text);
	 		    	var imgs=JSON.parse(text);
	 		    	console.log("imgs="+imgs.length);
	 		    	$("#img").children('div').remove();
	 		    	if(imgs!=null){
	                  	   var i = 0;
	                         for(; i < imgs.length; i++){
	                      	   
	                      	  var data=imgs[i];
	                      	  var name=data.name;
	                      	  var uri=data.uri;
	                      	  var date=actionTime(data.date);
	                      	  var panel=document.createElement("div");
	                      	  panel.setAttribute("class","weui-panel__bd");
	                        	   var a=document.createElement("a");
	                       	   a.setAttribute("class","weui_grid");
	                       	   var a=document.createElement("a");
	                       	  a.setAttribute("href","javascript:void(0);");
	                       	   a.setAttribute("class","weui-media-box weui-media-box_appmsg");
	                       	   var div=document.createElement("div");
	                       	  	div.setAttribute("class","weui-media-box__hd");
	                       	  
	                  	   	 	 src="/voucher/"+uri;
	                  	  	  	var img=document.createElement("img");
	                  	  	  	img.setAttribute("class","weui-media-box__thumb");
	                            	img.setAttribute("src",src);
	                          
	                         	  	div.appendChild(img);
	                         	   		
	                         	  	div2=document.createElement("div");
	                         	  		div2.setAttribute("class","weui-media-box__bd");
	                         	 		h4=document.createElement("h4");
	                         	 		h4.setAttribute("class","weui-media-box__title");
	                         	 	 	h4.innerHTML=name;
	                         	  	 	p=document.createElement("p");
	                         	  	 	p.setAttribute("class","weui-media-box__desc");
	                         	  	 	p.innerHTML=date;
	                         	     div2.appendChild(h4);
	                         	     div2.appendChild(p);
	                         	   a.appendChild(div);
	                         	   a.appendChild(div2);
	                         	   panel.appendChild(a);
	                  	      	  $("#img").append(panel);
	                         }
	          		   
	          	   		}
	 		    });
	        }
	    });
  }	

	 
</script>


<script src="../../js/previewImage.min.js"></script>

<script>
 
 var im = {};
 /**
  * 得到多个元素
  * @public
  */
 im.all = function(selector, contextElement) {
     var nodeList,
         list = [];
     if (contextElement) {
         nodeList = contextElement.querySelectorAll(selector);
     } else {
         nodeList = document.querySelectorAll(selector);
     }
     if (nodeList && nodeList.length > 0) {
         list = Array.prototype.slice.call(nodeList);
     }
     return list;
 }

 /**
  * 将事件委托给父元素
  * @public
  * @param  array     $el         父元素
  * @param  string    eventType  事件类型名称
  * @param  string    selector   目标的选择器
  * @param  function  fn
  */
 im.delegate = function($el, eventType, selector, fn) {
     if (!$el) { return; }
     $el.addEventListener(eventType, function(e) {
         var targets = im.all(selector, $el);
         if (!targets) {
             return;
         }
         // findTarget:
         for (var i=0; i<targets.length; i++) {
             var $node = e.target;
             while ($node) {
                 if ($node == targets[i]) {
                     fn.call($node, e);
                     break; //findTarget;
                 }
                 $node = $node.parentNode;
                 if ($node == $el) {
                     break;
                 }
             }
         }
     }, false);
 };


 im.delegate(document.querySelector('#img'), 'click','img',function(){
	 
	 var urls = [];
	 var imgs = im.all('img',im.all('#img')[0]);
	 imgs.forEach(function(v,i){
		 var str=v.src;
		 var url=str.replace(/\/compressFile/, "");
	     urls.push(url);
	 })
     
	 var thisStr = this.src;
	 var current = thisStr.replace(/\/compressFile/, "");
	 console.log(current);
     var obj = {
         urls : urls,
         current : current
     };
     previewImage.start(obj);
 });	
 
 </script>